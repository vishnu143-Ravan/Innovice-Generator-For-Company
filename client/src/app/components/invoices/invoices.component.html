<div class="p-6">
  <div class="flex justify-between items-center mb-6">
    <h2 class="text-2xl font-bold text-gray-800">{{ t.get('invoices.title') }}</h2>
    <p-button icon="pi pi-plus" [label]="t.get('invoices.generateInvoice')" (onClick)="openGenerateDialog()"></p-button>
  </div>
  
  <div class="bg-white rounded-lg shadow-md">
    <div class="p-4">
      <p-table [value]="invoices" [paginator]="true" [rows]="10" [showCurrentPageReport]="true"
               [rowsPerPageOptions]="[5,10,25,50]" dataKey="id" [loading]="loading"
               currentPageReportTemplate="Showing {first} to {last} of {totalRecords} invoices">
        <ng-template pTemplate="header">
          <tr>
            <th pSortableColumn="invoiceNumber">{{ t.get('invoices.invoiceNumber') }} <p-sortIcon field="invoiceNumber"></p-sortIcon></th>
            <th>{{ t.get('invoices.client') }}</th>
            <th>{{ t.get('invoices.project') }}</th>
            <th>{{ t.get('invoices.dateRange') }}</th>
            <th pSortableColumn="total">{{ t.get('invoices.totalAmount') }} <p-sortIcon field="total"></p-sortIcon></th>
            <th>{{ t.get('invoices.status') }}</th>
            <th pSortableColumn="createdAt">Created <p-sortIcon field="createdAt"></p-sortIcon></th>
            <th class="w-48">{{ t.get('common.actions') }}</th>
          </tr>
        </ng-template>
        <ng-template pTemplate="body" let-invoice>
          <tr>
            <td>{{ invoice.invoiceNumber }}</td>
            <td>{{ invoice.client?.clientName || '-' }}</td>
            <td>{{ invoice.project?.projectName || 'All Projects' }}</td>
            <td>{{ invoice.dateFrom | date:'mediumDate' }} - {{ invoice.dateTo | date:'mediumDate' }}</td>
            <td>${{ invoice.total | number:'1.2-2' }}</td>
            <td>
              <span class="px-2 py-1 rounded-full text-xs font-medium" [ngClass]="getStatusClass(invoice.status)">
                {{ formatStatus(invoice.status) }}
              </span>
            </td>
            <td>{{ invoice.createdAt | date:'mediumDate' }}</td>
            <td>
              <p-button icon="pi pi-eye" [rounded]="true" [text]="true" (onClick)="viewInvoice(invoice)" [pTooltip]="t.get('invoices.viewDetails')"></p-button>
              <p-button icon="pi pi-download" [rounded]="true" [text]="true" (onClick)="downloadPdf(invoice)" [pTooltip]="t.get('invoices.downloadPdf')"></p-button>
              <p-button icon="pi pi-check" [rounded]="true" [text]="true" severity="success" (onClick)="markAsPaid(invoice)" 
                        *ngIf="invoice.status !== 'paid'" pTooltip="Mark as Paid"></p-button>
              <p-button icon="pi pi-trash" [rounded]="true" [text]="true" severity="danger" (onClick)="confirmDelete(invoice)" [pTooltip]="t.get('common.delete')"></p-button>
            </td>
          </tr>
        </ng-template>
        <ng-template pTemplate="emptymessage">
          <tr>
            <td colspan="8" class="text-center text-gray-500 py-8">{{ t.get('common.noData') }}</td>
          </tr>
        </ng-template>
      </p-table>
    </div>
  </div>
  
  <p-dialog [(visible)]="generateDialogVisible" [header]="t.get('invoices.generateInvoice')" [modal]="true" [style]="{width: '500px'}">
    <div class="mb-4">
      <label for="client" class="block text-sm font-semibold text-gray-700 mb-1">{{ t.get('invoices.client') }} <span class="text-red-500">*</span></label>
      <p-select id="client" [(ngModel)]="generateData.clientId" [options]="clientOptions" 
                optionLabel="label" optionValue="value" [placeholder]="t.get('invoices.client')" 
                class="w-full" (onChange)="onClientChange()"
                [ngClass]="{'ng-invalid ng-dirty': submitted && !generateData.clientId}"></p-select>
      <small *ngIf="submitted && !generateData.clientId" class="text-red-500 text-sm">{{ t.get('common.required') }}</small>
    </div>
    <div class="mb-4">
      <label for="project" class="block text-sm font-semibold text-gray-700 mb-1">{{ t.get('invoices.project') }}</label>
      <p-select id="project" [(ngModel)]="generateData.projectId" [options]="clientProjectOptions" 
                optionLabel="label" optionValue="value" [placeholder]="t.get('invoices.project')" 
                [showClear]="true" class="w-full"></p-select>
    </div>
    <div class="grid grid-cols-2 gap-4">
      <div class="mb-4">
        <label for="dateFrom" class="block text-sm font-semibold text-gray-700 mb-1">{{ t.get('invoices.fromDate') }} <span class="text-red-500">*</span></label>
        <p-datepicker id="dateFrom" [(ngModel)]="dateFromObj" dateFormat="yy-mm-dd" class="w-full"
                      [ngClass]="{'ng-invalid ng-dirty': submitted && !dateFromObj}"></p-datepicker>
        <small *ngIf="submitted && !dateFromObj" class="text-red-500 text-sm">{{ t.get('common.required') }}</small>
      </div>
      <div class="mb-4">
        <label for="dateTo" class="block text-sm font-semibold text-gray-700 mb-1">{{ t.get('invoices.toDate') }} <span class="text-red-500">*</span></label>
        <p-datepicker id="dateTo" [(ngModel)]="dateToObj" dateFormat="yy-mm-dd" class="w-full"
                      [ngClass]="{'ng-invalid ng-dirty': submitted && !dateToObj}"></p-datepicker>
        <small *ngIf="submitted && !dateToObj" class="text-red-500 text-sm">{{ t.get('common.required') }}</small>
      </div>
    </div>
    <div class="flex justify-end gap-2 mt-6">
      <p-button [label]="t.get('common.cancel')" [text]="true" (onClick)="generateDialogVisible = false"></p-button>
      <p-button label="Generate" (onClick)="generateInvoice()"></p-button>
    </div>
  </p-dialog>
  
  <p-dialog [(visible)]="viewDialogVisible" [header]="'Invoice ' + (selectedInvoice?.invoiceNumber || '')" [modal]="true" [style]="{width: '700px'}">
    <div *ngIf="selectedInvoice" class="p-4">
      <div class="flex justify-between mb-6 pb-4 border-b border-gray-200">
        <div>
          <h3 class="text-xl font-bold mb-2">Invoice</h3>
          <p class="text-gray-700 mb-1"><strong>Invoice #:</strong> {{ selectedInvoice.invoiceNumber }}</p>
          <p class="text-gray-700"><strong>Date:</strong> {{ selectedInvoice.createdAt | date:'mediumDate' }}</p>
        </div>
        <div class="text-right">
          <p class="text-gray-700 mb-1"><strong>Bill To:</strong></p>
          <p class="text-gray-700 mb-1">{{ selectedInvoice.client?.clientName }}</p>
          <p class="text-gray-700 mb-1">{{ selectedInvoice.client?.email }}</p>
          <p class="text-gray-700">{{ selectedInvoice.client?.address || '' }}</p>
        </div>
      </div>
      
      <p class="text-gray-700 mb-2"><strong>Period:</strong> {{ selectedInvoice.dateFrom | date:'mediumDate' }} - {{ selectedInvoice.dateTo | date:'mediumDate' }}</p>
      <p *ngIf="selectedInvoice.project" class="text-gray-700 mb-4"><strong>Project:</strong> {{ selectedInvoice.project.projectName }}</p>
      
      <table class="w-full border-collapse">
        <thead class="bg-gray-800 text-white">
          <tr>
            <th class="p-3 text-left">Description</th>
            <th class="p-3 text-left">Quantity</th>
            <th class="p-3 text-left">Rate</th>
            <th class="p-3 text-left">Amount</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let item of selectedInvoice.lineItems; let odd = odd" [class]="odd ? 'bg-gray-50' : 'bg-white'">
            <td class="p-3 border-b border-gray-200">{{ item.description }}</td>
            <td class="p-3 border-b border-gray-200">{{ item.quantity }}</td>
            <td class="p-3 border-b border-gray-200">${{ item.rate | number:'1.2-2' }}</td>
            <td class="p-3 border-b border-gray-200">${{ item.amount | number:'1.2-2' }}</td>
          </tr>
        </tbody>
        <tfoot>
          <tr>
            <td colspan="3" class="p-3 text-right font-semibold">Subtotal:</td>
            <td class="p-3">${{ selectedInvoice.subtotal | number:'1.2-2' }}</td>
          </tr>
          <tr>
            <td colspan="3" class="p-3 text-right font-semibold">Tax:</td>
            <td class="p-3">${{ selectedInvoice.tax | number:'1.2-2' }}</td>
          </tr>
          <tr class="bg-gray-800 text-white">
            <td colspan="3" class="p-3 text-right font-bold">Total:</td>
            <td class="p-3 font-bold">${{ selectedInvoice.total | number:'1.2-2' }}</td>
          </tr>
        </tfoot>
      </table>
    </div>
    <div class="flex justify-end gap-2 mt-6">
      <p-button [label]="t.get('common.cancel')" [text]="true" (onClick)="viewDialogVisible = false"></p-button>
      <p-button [label]="t.get('invoices.downloadPdf')" icon="pi pi-download" (onClick)="downloadPdf(selectedInvoice!)"></p-button>
    </div>
  </p-dialog>
  
  <p-confirmDialog></p-confirmDialog>
  <p-toast></p-toast>
</div>
