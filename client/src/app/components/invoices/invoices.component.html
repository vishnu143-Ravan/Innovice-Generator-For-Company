<div class="container-fluid p-4">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="mb-0">Invoices</h2>
    <p-button icon="pi pi-plus" label="Generate Invoice" (onClick)="openGenerateDialog()"></p-button>
  </div>
  
  <div class="card shadow-sm">
    <div class="card-body">
      <p-table [value]="invoices" [paginator]="true" [rows]="10" [showCurrentPageReport]="true"
               [rowsPerPageOptions]="[5,10,25,50]" dataKey="id" [loading]="loading"
               currentPageReportTemplate="Showing {first} to {last} of {totalRecords} invoices">
        <ng-template pTemplate="header">
          <tr>
            <th pSortableColumn="invoiceNumber">Invoice # <p-sortIcon field="invoiceNumber"></p-sortIcon></th>
            <th>Client</th>
            <th>Project</th>
            <th>Period</th>
            <th pSortableColumn="total">Total <p-sortIcon field="total"></p-sortIcon></th>
            <th>Status</th>
            <th pSortableColumn="createdAt">Created <p-sortIcon field="createdAt"></p-sortIcon></th>
            <th style="width: 200px">Actions</th>
          </tr>
        </ng-template>
        <ng-template pTemplate="body" let-invoice>
          <tr>
            <td>{{ invoice.invoiceNumber }}</td>
            <td>{{ invoice.client?.clientName || '-' }}</td>
            <td>{{ invoice.project?.projectName || 'All Projects' }}</td>
            <td>{{ invoice.dateFrom | date:'mediumDate' }} - {{ invoice.dateTo | date:'mediumDate' }}</td>
            <td>${{ invoice.total | number:'1.2-2' }}</td>
            <td>
              <span class="badge" [ngClass]="getStatusClass(invoice.status)">{{ formatStatus(invoice.status) }}</span>
            </td>
            <td>{{ invoice.createdAt | date:'mediumDate' }}</td>
            <td>
              <p-button icon="pi pi-eye" [rounded]="true" [text]="true" (onClick)="viewInvoice(invoice)" pTooltip="View"></p-button>
              <p-button icon="pi pi-download" [rounded]="true" [text]="true" (onClick)="downloadPdf(invoice)" pTooltip="Download PDF"></p-button>
              <p-button icon="pi pi-check" [rounded]="true" [text]="true" severity="success" (onClick)="markAsPaid(invoice)" 
                        *ngIf="invoice.status !== 'paid'" pTooltip="Mark as Paid"></p-button>
              <p-button icon="pi pi-trash" [rounded]="true" [text]="true" severity="danger" (onClick)="confirmDelete(invoice)" pTooltip="Delete"></p-button>
            </td>
          </tr>
        </ng-template>
        <ng-template pTemplate="emptymessage">
          <tr>
            <td colspan="8" class="text-center text-muted py-4">No invoices found. Click "Generate Invoice" to create one.</td>
          </tr>
        </ng-template>
      </p-table>
    </div>
  </div>
  
  <p-dialog [(visible)]="generateDialogVisible" header="Generate Invoice" [modal]="true" [style]="{width: '500px'}">
    <div class="mb-3">
      <label for="client" class="form-label fw-semibold">Client <span class="text-danger">*</span></label>
      <p-select id="client" [(ngModel)]="generateData.clientId" [options]="clientOptions" 
                optionLabel="label" optionValue="value" placeholder="Select client" 
                class="w-100" (onChange)="onClientChange()"
                [ngClass]="{'ng-invalid ng-dirty': submitted && !generateData.clientId}"></p-select>
      <small *ngIf="submitted && !generateData.clientId" class="text-danger">Client is required</small>
    </div>
    <div class="mb-3">
      <label for="project" class="form-label fw-semibold">Project (optional)</label>
      <p-select id="project" [(ngModel)]="generateData.projectId" [options]="clientProjectOptions" 
                optionLabel="label" optionValue="value" placeholder="All projects for this client" 
                [showClear]="true" class="w-100"></p-select>
    </div>
    <div class="row">
      <div class="col-6">
        <div class="mb-3">
          <label for="dateFrom" class="form-label fw-semibold">From Date <span class="text-danger">*</span></label>
          <p-datepicker id="dateFrom" [(ngModel)]="dateFromObj" dateFormat="yy-mm-dd" class="w-100"
                        [ngClass]="{'ng-invalid ng-dirty': submitted && !dateFromObj}"></p-datepicker>
          <small *ngIf="submitted && !dateFromObj" class="text-danger">From date is required</small>
        </div>
      </div>
      <div class="col-6">
        <div class="mb-3">
          <label for="dateTo" class="form-label fw-semibold">To Date <span class="text-danger">*</span></label>
          <p-datepicker id="dateTo" [(ngModel)]="dateToObj" dateFormat="yy-mm-dd" class="w-100"
                        [ngClass]="{'ng-invalid ng-dirty': submitted && !dateToObj}"></p-datepicker>
          <small *ngIf="submitted && !dateToObj" class="text-danger">To date is required</small>
        </div>
      </div>
    </div>
    <div class="d-flex justify-content-end gap-2 mt-4">
      <p-button label="Cancel" [text]="true" (onClick)="generateDialogVisible = false"></p-button>
      <p-button label="Generate" (onClick)="generateInvoice()"></p-button>
    </div>
  </p-dialog>
  
  <p-dialog [(visible)]="viewDialogVisible" [header]="'Invoice ' + (selectedInvoice?.invoiceNumber || '')" [modal]="true" [style]="{width: '700px'}">
    <div *ngIf="selectedInvoice" class="p-3">
      <div class="d-flex justify-content-between mb-4 pb-3 border-bottom">
        <div>
          <h3 class="mb-2">Invoice</h3>
          <p class="mb-1"><strong>Invoice #:</strong> {{ selectedInvoice.invoiceNumber }}</p>
          <p class="mb-0"><strong>Date:</strong> {{ selectedInvoice.createdAt | date:'mediumDate' }}</p>
        </div>
        <div class="text-end">
          <p class="mb-1"><strong>Bill To:</strong></p>
          <p class="mb-1">{{ selectedInvoice.client?.clientName }}</p>
          <p class="mb-1">{{ selectedInvoice.client?.email }}</p>
          <p class="mb-0">{{ selectedInvoice.client?.address || '' }}</p>
        </div>
      </div>
      
      <p class="mb-2"><strong>Period:</strong> {{ selectedInvoice.dateFrom | date:'mediumDate' }} - {{ selectedInvoice.dateTo | date:'mediumDate' }}</p>
      <p *ngIf="selectedInvoice.project" class="mb-3"><strong>Project:</strong> {{ selectedInvoice.project.projectName }}</p>
      
      <table class="table table-striped">
        <thead class="table-dark">
          <tr>
            <th>Description</th>
            <th>Quantity</th>
            <th>Rate</th>
            <th>Amount</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let item of selectedInvoice.lineItems">
            <td>{{ item.description }}</td>
            <td>{{ item.quantity }}</td>
            <td>${{ item.rate | number:'1.2-2' }}</td>
            <td>${{ item.amount | number:'1.2-2' }}</td>
          </tr>
        </tbody>
        <tfoot>
          <tr>
            <td colspan="3" class="text-end fw-semibold">Subtotal:</td>
            <td>${{ selectedInvoice.subtotal | number:'1.2-2' }}</td>
          </tr>
          <tr>
            <td colspan="3" class="text-end fw-semibold">Tax:</td>
            <td>${{ selectedInvoice.tax | number:'1.2-2' }}</td>
          </tr>
          <tr class="table-dark">
            <td colspan="3" class="text-end fw-bold">Total:</td>
            <td class="fw-bold">${{ selectedInvoice.total | number:'1.2-2' }}</td>
          </tr>
        </tfoot>
      </table>
    </div>
    <div class="d-flex justify-content-end gap-2 mt-4">
      <p-button label="Close" [text]="true" (onClick)="viewDialogVisible = false"></p-button>
      <p-button label="Download PDF" icon="pi pi-download" (onClick)="downloadPdf(selectedInvoice!)"></p-button>
    </div>
  </p-dialog>
  
  <p-confirmDialog></p-confirmDialog>
  <p-toast></p-toast>
</div>
